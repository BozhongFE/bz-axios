import t from"qs";import r from"axios";function e(t){return function(t,r){return Object.prototype.toString.call(t).indexOf(r)>=0}(t,"Array")}function o(t){return void 0!==t.url}var n=function t(r,e,o,n,a,i){void 0===e&&(e={}),void 0===o&&(o={}),void 0===a&&(a=!1),this.params={},this.ajaxHeaders={},this.debug=!1,this.withCredentials=!0;var s=Object.create(t.prototype);return this.params=e,this.ajaxHeaders=o,this.debug=a,this.withCredentials=i,this.handleRequestor(n,s),this.createMethods(r,s)};n.prototype.createMethods=function(t,r){var e=this,n=function(t,a){for(var i in t){var s=t[i];"string"==typeof s?e.createRequest(r,a,i,s):o(s)?e.createRequest(r,a,i,s.url,s.type):(a[i]||(a[i]={}),n(s,a[i]))}};return n(t,r),r},n.prototype.createRequest=function(t,r,o,n,a){void 0===a&&(a="get");var i=function(r){return function(e,o){return t._requestProxy(n,r,e,o)}},s=[];e(a)?s.push.apply(s,a):s.push(a);var u=s.some((function(t){return/get/gi.test(t)}));u&&(r[o]=i("get")),u||r[o]||(r[o]={}),s.forEach((function(t){r[o][t.toUpperCase()]=i(t)}))},n.prototype.handleRequestor=function(t,r){var e,o=this.params,n=this.ajaxHeaders,a=this.debug,i=this.withCredentials;switch(t.name){case"AxiosRequest":e=new t(o,n,a,i);break;case"TaroRequest":e=new t(o,n,a);break;default:e=new t(o,n,a)}for(var s in["_requestProxy","_res","_defaultError","_networkError"].forEach((function(r){Object.defineProperty(e,r,{get:function(){return t.prototype[r]},enumerable:!0})})),e)"constructor"!==s&&(r[s]=e[s]);return r};var a=function(t){void 0===t&&(t=!1),this.debug=t};a.prototype._getUrlParams=function(t){var r=t,e=r.indexOf("?"),o={};return-1!==e?((r=r.substr(e+1)).split("&").forEach((function(t){var r=t.split("=");o[r[0]]=r[1]})),o):o},a.prototype._setUrlParam=function(t,r){if(void 0===r&&(r={}),!t)return t;var e=Object.assign(this._getUrlParams(t),r),o=t.indexOf("?");return(-1!==o?t.substring(0,o):t)+"?"+Object.keys(e).map((function(t){return t+"="+r[t]})).join("&")},a.prototype._shunt=function(){for(var t=this,r=[],e=arguments.length;e--;)r[e]=arguments[e];return function(){for(var e=[],o=arguments.length;o--;)e[o]=arguments[o];r.forEach((function(r){"[object Function]"===Object.prototype.toString.call(r)&&r.apply(t,e)}))}},a.prototype._shuntAsync=function(){for(var t=[],r=arguments.length;r--;)t[r]=arguments[r];return function(){for(var r=[],e=arguments.length;e--;)r[e]=arguments[e];var o=0,n=function(){"[object Function]"===Object.prototype.toString.call(t[o])&&t[o].apply(t,r.concat((function(){(o+=1)<t.length&&n()})))};n()}},a.prototype._res=function(t,r,e,o,n){this.debug&&(console.log(t),this.debug=!1),0===t.error_code?r&&r(t):e?e(t):this._defaultError(t,"data"),o&&o(t),n&&n(t)},a.prototype._defaultError=function(t,r){return void 0===r&&(r="networkError"),"data"===r?console.log("格式异常："+(t&&"string"==typeof t?t:t.error_message)):console.error(t)},a.prototype._networkError=function(t,r){var e=this;return function(o){throw e._defaultError(o),r&&r(o),t&&t(o),new Error(o)}};var i=function(e){function o(t,o,n,a){void 0===t&&(t={}),void 0===o&&(o={}),void 0===n&&(n=!1),void 0===a&&(a=!0),e.call(this,n),this.params=t,this.ajaxHeaders=o,r.defaults.withCredentials=a}return e&&(o.__proto__=e),o.prototype=Object.create(e&&e.prototype),o.prototype.constructor=o,o.prototype._requestProxy=function(e,o,n,a){var i=this;void 0===o&&(o="get"),void 0===n&&(n={}),void 0===a&&(a={});var s=(n.type||o).toLowerCase(),u="form"===s?"post":s,c=!/post|put|delete/gi.test(u),p=c?"params":"data",f=Object.assign({},this.params,n.data),d={method:u,url:e};for(var h in d[p]=c?f:t.stringify(f),d.headers={},/put|delete/gi.test(s)?d.headers["Content-Type"]="application/x-www-form-urlencoded":/form/gi.test(s)&&(d.headers["Content-Type"]="multipart/form-data",d.onUploadProgress=function(t){n.progress&&n.progress(t)}),this.ajaxHeaders&&Object.assign(d.headers,this.ajaxHeaders),a)Object.prototype.hasOwnProperty.call(a,h)&&(d[h]=a[h]);return new Promise((function(t,e){r(d).then((function(r){var e=n.success,o=n.error,a=n.complete,s=n.requestComplete;i._res(r.data,e,o,a,s),t(r)})).catch((function(t){var r=n.networkError,o=n.requestComplete;return e(t),i._networkError(r,o)(t)}))}))},o}(a);export default function(t,r,e,o,a){return void 0===r&&(r={}),void 0===e&&(e={}),void 0===o&&(o=!1),void 0===a&&(a=!0),new n(t,r,e,i,o,a)}
